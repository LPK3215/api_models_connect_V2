# å¤šæ¨¡æ€æ‰¹å¤„ç†ç³»ç»Ÿ - é¡¹ç›®ç®¡ç† Makefile

.PHONY: help install test lint format clean run-cli run-api cleanup check

help:  ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "ğŸš€ å¤šæ¨¡æ€æ‰¹å¤„ç†ç³»ç»Ÿ - å¯ç”¨å‘½ä»¤:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

install:  ## å®‰è£…é¡¹ç›®ä¾èµ–
	@echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
	pip install -r requirements.txt
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆï¼"

check:  ## è¿è¡Œå®Œæ•´ç³»ç»Ÿæ£€æµ‹ï¼ˆæ¨èï¼‰
	@echo "ğŸ” è¿è¡Œå®Œæ•´ç³»ç»Ÿæ£€æµ‹..."
	python scripts/check_auto.py

check-project:  ## æ£€æµ‹é¡¹ç›®ä»£ç 
	@echo "ğŸ—ï¸  æ£€æµ‹é¡¹ç›®ä»£ç ..."
	python tests/check_project.py

check-local:  ## æ£€æµ‹æœ¬åœ°ç¯å¢ƒ
	@echo "ğŸ’» æ£€æµ‹æœ¬åœ°ç¯å¢ƒ..."
	python tests/check_local.py

check-cloud:  ## æ£€æµ‹äº‘æœåŠ¡å™¨ç¯å¢ƒ
	@echo "â˜ï¸  æ£€æµ‹äº‘æœåŠ¡å™¨ç¯å¢ƒ..."
	python tests/check_cloud.py

test:  ## è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
	@echo "ğŸ§ª è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶..."
	python tests/test_all.py

lint:  ## ä»£ç è´¨é‡æ£€æŸ¥
	@echo "ğŸ” ä»£ç è´¨é‡æ£€æŸ¥..."
	flake8 src/backend/ tests/ --max-line-length=100

format:  ## æ ¼å¼åŒ–ä»£ç ï¼ˆå¦‚æœå®‰è£…äº†blackï¼‰
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	@if command -v black >/dev/null 2>&1; then \
		black src/backend/ tests/ --line-length=100; \
		echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆï¼"; \
	else \
		echo "âš ï¸  blackæœªå®‰è£…ï¼Œè·³è¿‡æ ¼å¼åŒ–"; \
	fi

clean:  ## æ¸…ç†é¡¹ç›®æ–‡ä»¶
	@echo "ğŸ§¹ å¯åŠ¨é¡¹ç›®æ¸…ç†å·¥å…·..."
	python tests/cleanup.py

clean-cache:  ## æ¸…ç†Pythonç¼“å­˜æ–‡ä»¶
	@echo "ğŸ—‚ï¸  æ¸…ç†Pythonç¼“å­˜æ–‡ä»¶..."
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -name "*.pyc" -delete 2>/dev/null || true
	@echo "âœ… ç¼“å­˜æ–‡ä»¶æ¸…ç†å®Œæˆï¼"

run-api:  ## å¯åŠ¨åç«¯ API (FastAPI)
	@echo "ğŸŒ å¯åŠ¨åç«¯ API (FastAPI)..."
	python run_api.py

run-cli:  ## ç›´æ¥å¯åŠ¨CLIç•Œé¢
	@echo "ğŸ’» å¯åŠ¨CLIç•Œé¢..."
	python run_cli.py

status:  ## æ£€æŸ¥é¡¹ç›®çŠ¶æ€
	@echo "ğŸ“Š æ£€æŸ¥é¡¹ç›®çŠ¶æ€..."
	@python -c "import sys; sys.path.insert(0, 'src'); from backend.services.config_service import ConfigService; cs = ConfigService(); status = cs.get_system_status(); print(f'äº‘å¹³å°: {status[\"statistics\"][\"providers\"]}ä¸ª, æ¨¡å‹: {status[\"statistics\"][\"models\"]}ä¸ª, æç¤ºè¯: {status[\"statistics\"][\"prompts\"]}ä¸ª')"

check-deps:  ## æ£€æŸ¥ä¾èµ–æ˜¯å¦å®‰è£…
	@echo "ğŸ” æ£€æŸ¥ä¾èµ–..."
	@python -c "import openai, yaml, PIL, fastapi, uvicorn, multipart; print('âœ… æ ¸å¿ƒä¾èµ–å·²å®‰è£…')" 2>/dev/null || echo "âŒ ç¼ºå°‘ä¾èµ–ï¼Œè¯·è¿è¡Œ make install"

dev-setup: install  ## å¼€å‘ç¯å¢ƒè®¾ç½®
	@echo "ğŸ› ï¸  å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆï¼"
	@echo "ğŸ“š è¿è¡Œ 'make help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤"
	@echo "ğŸš€ è¿è¡Œ 'make run-api' å¯åŠ¨åç«¯"

quick-start: check-deps status run-api  ## å¿«é€Ÿå¯åŠ¨ï¼ˆæ£€æŸ¥+å¯åŠ¨ï¼‰
